#include <16F887.h>
#fuses HS, NOWDT, NOPROTECT, NOLVP
#use delay(clock=12000000)
#use fast_io(B)
#use fast_io(D)
#use fast_io(C)

#define PIR_SENSOR PIN_B0
#define GREEN_LED PIN_D2
#define RED_LED PIN_D3
#define SERVO_PIN PIN_C2

// Hàm debounce cho c?m bi?n SR501
int debounce_pir() {
   int count = 0;
   for(int i = 0; i < 5; i++) {
      if(input(PIR_SENSOR)) count++;
      delay_ms(10);
   }
   return (count >= 3); // Tr? v? 1 n?u tín hi?u ?n d?nh
}

// Hàm di?u khi?n servo b?ng bit-banging
void servo_pulse(int us) {
   output_high(SERVO_PIN);
   delay_us(us);
   output_low(SERVO_PIN);
}

void main() {
   // C?u hình c?ng
   set_tris_b(0x01); // RB0 là input (SR501)
   set_tris_d(0x00); // RD2, RD3 là output (LED)
   set_tris_c(0x00); // RC2 là output (Servo)

   // Kh?i t?o LED
   output_low(GREEN_LED);
   output_low(RED_LED);

   int angle = 0;
   int detecting = 0;

   while(TRUE) {
      if(debounce_pir()) { // Phát hi?n ngu?i
         if(!detecting) { // Chuy?n t? không phát hi?n sang phát hi?n
            detecting = 1;
            output_high(GREEN_LED); // B?t LED xanh
            output_low(RED_LED);    // T?t LED d?
            
            // Quay servo t? 0° d?n 90° (ch?m)
            for(angle = 0; angle <= 90; angle += 2) {
               servo_pulse(500 + (angle * 1000 / 180)); // Góc 0°: 500us, 180°: 2500us
               delay_ms(50);
            }
         }
         
         output_low(GREEN_LED);  // T?t LED xanh
         output_high(RED_LED);   // B?t LED d?
         
         // Gi? servo ? 90° trong 5 giây
         delay_ms(5000);
         
         // Quay servo v? 0° (ch?m)
         for(angle = 90; angle >= 0; angle -= 2) {
            servo_pulse(500 + (angle * 1000 / 180));
            delay_ms(50);
            if(debounce_pir()) { // N?u phát hi?n ngu?i trong lúc quay v?
               // Quay l?i 90°
               for(angle = angle; angle <= 90; angle += 2) {
                  servo_pulse(500 + (angle * 1000 / 180));
                  delay_ms(50);
               }
               output_low(GREEN_LED); // T?t LED xanh
               output_high(RED_LED);  // B?t LED d?
               delay_ms(5000);        // Gi? 5 giây
            }
         }
      } else { // Không phát hi?n ngu?i
         detecting = 0;
         output_low(GREEN_LED); // T?t LED xanh
         output_low(RED_LED);   // T?t LED d?
         servo_pulse(500);      // Servo ? 0°
      }
   }
}
