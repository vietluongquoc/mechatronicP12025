#include <16F887.h>
#fuses XT, NOWDT, NOMCLR
#use delay(clock=12000000)

#define PIR       PIN_A0
#define LED_XANH  PIN_D2
#define LED_DO    PIN_D3
#define IN1       PIN_C0
#define IN2       PIN_C1

void motor_forward() {
   output_high(IN1);
   output_low(IN2);
}

void motor_reverse() {
   output_low(IN1);
   output_high(IN2);
}

void motor_stop() {
   output_low(IN1);
   output_low(IN2);
}

void main() {
   set_tris_a(0xFF); // PIR input
   set_tris_c(0x00); // Motor output
   set_tris_d(0x00); // LED output

   output_low(LED_XANH);
   output_low(LED_DO);
   motor_stop();

   while(TRUE) {
      if(input(PIR)) {
         // Giai do?n m? c?a
         output_high(LED_XANH);
         output_high(LED_DO);
         motor_forward();
         delay_ms(1000);
         motor_stop();
         output_low(LED_DO);

         // Ch? 2s
         delay_ms(2000);

         // C?nh báo s?p dóng
         output_high(LED_DO);

         // B?t d?u dóng c?a
         motor_reverse();

         int nguoi_phat_hien = 0;
         for(int i = 0; i < 30; i++) {
            delay_ms(100);
            if(input(PIR)) {
               // N?u có ngu?i khi dang dóng, chuy?n qua m?
               nguoi_phat_hien = 1;
               break;
            }
         }

         motor_stop();
         output_low(LED_DO);

         if(nguoi_phat_hien) {
            // M? l?i c?a
            output_high(LED_XANH);
            output_high(LED_DO);
            motor_forward();
            delay_ms(1000);
            motor_stop();
            output_low(LED_DO);
            output_low(LED_XANH);

            // Sau khi m? l?i thì v?n ph?i dóng ti?p
            delay_ms(2000);

            output_high(LED_DO);
            motor_reverse();
            delay_ms(1000);  // quay ngu?c l?i d? dóng
            motor_stop();
            output_low(LED_DO);
         }

         output_low(LED_XANH);
      }
   }
}

