#include <16F887.h>
#fuses XT, NOWDT
#use delay(clock=12000000)

#define cambien    PIN_A1
#define ledxanh    PIN_D2
#define leddo      PIN_D3
#define IN1        PIN_C0
#define IN2        PIN_C1
#define ctmo       PIN_B0
#define ctdong     PIN_B1
#define nut_mo     PIN_A2
#define nut_dong   PIN_A4
#define nut_tay    PIN_A3

int che_do_tay = 0;

void quaythuan() {
   output_high(IN1);
   output_low(IN2);
}

void quaynguoc() {
   output_low(IN1);
   output_high(IN2);
}

void dung() {
   output_low(IN1);
   output_low(IN2);
}

void main() {
   set_tris_a(0xFF);
   set_tris_b(0xFF);
   set_tris_c(0x00);
   set_tris_d(0x00);

   output_low(ledxanh);
   output_low(leddo);
   dung();

   int trang_thai_nut_tay = 1;

   while(TRUE) {
      // Toggle ch? d? tay khi nh?n nút
      if(!input(nut_tay) && trang_thai_nut_tay == 1) {
         che_do_tay = !che_do_tay;
         trang_thai_nut_tay = 0;
         delay_ms(300); // ch?ng d?i và ch? th? nút
      }
      if(input(nut_tay)) trang_thai_nut_tay = 1;

      if(che_do_tay == 1) {
         // Ch? d? tay
         if(!input(nut_mo)) {
            quaythuan();
            output_high(leddo);
         } else if(!input(nut_dong)) {
            quaynguoc();
            output_high(leddo);
         } else {
            dung();
            output_low(leddo);
         }
      } else {
         // Ch? d? c?m bi?n
         if(input(cambien)) {
            if(input(ctmo)) {
               output_high(ledxanh);
               delay_ms(200); 
               output_high(leddo);
               quaythuan();
               output_low(ledxanh);
               while(input(ctmo)) {
                  if(!input(ctmo)) break;
               }
               dung();
               output_low(leddo);
            }
            delay_ms(2000);
         dong_cua:
            if(input(ctdong)) {
               output_high(leddo);
               quaynguoc();
               while(input(ctdong)) {
                  if(input(cambien)) {
                     if(input(ctmo)) {
                        output_high(ledxanh);
                        delay_ms(200);
                        output_low(ledxanh);
                        quaythuan();                      
                        while(input(ctmo)) {
                           if(!input(ctmo)) break;
                        }
                        dung();
                        output_low(leddo);
                        output_low(ledxanh);
                     }
                     delay_ms(2000); 
                     goto dong_cua; 
                  }
               }
               dung();
               output_low(leddo);
            }
            output_low(ledxanh);
         }
      }
   }
}

