#include <16F887.h>
#fuses XT, NOWDT, NOMCLR
#use delay(clock=12000000)

#define PIR         PIN_A0
#define LED_XANH    PIN_D2
#define LED_DO      PIN_D3
#define IN1         PIN_C0
#define IN2         PIN_C1
#define LIMIT_OPEN  PIN_D4
#define LIMIT_CLOSE PIN_D5

void motor_forward() {
   output_high(IN1);
   output_low(IN2);
}

void motor_reverse() {
   output_low(IN1);
   output_high(IN2);
}

void motor_stop() {
   output_low(IN1);
   output_low(IN2);
}

void wait_until_limit(input_pin_t limit_pin, int timeout_ms) {
   int count = timeout_ms / 50;
   for(int i = 0; i < count; i++) {
      if(input(limit_pin)) break;
      delay_ms(50);
   }
}

void main() {
   set_tris_a(0xFF); // RA0 input (PIR)
   set_tris_c(0x00); // PORTC output (Motor)
   set_tris_d(0xF0); // RD2, RD3 output; RD4, RD5 input (limit switches)

   output_low(LED_XANH);
   output_low(LED_DO);
   motor_stop();

   while(TRUE) {
      if(input(PIR)) {
         // Giai do?n m? c?a
         output_high(LED_XANH); // Có ngu?i
         output_high(LED_DO);   // Motor ho?t d?ng
         motor_forward();

         // Ð?i t?i khi nh?n công t?c m? ho?c timeout 5s
         wait_until_limit(LIMIT_OPEN, 5000);
         motor_stop();
         output_low(LED_DO);

         // Ch? 5 giây tru?c khi dóng c?a
         delay_ms(5000);

         // Giai do?n dóng c?a
         output_high(LED_DO);
         motor_reverse();

         int i;
         for(i = 0; i < 100; i++) { // T?i da 5s (100 * 50ms)
            delay_ms(50);

            if(input(PIR)) {
               // Có ngu?i trong khi dang dóng -> m? l?i
               motor_forward();
               output_high(LED_XANH);
               wait_until_limit(LIMIT_OPEN, 5000);
               motor_stop();
               output_low(LED_DO);
               output_low(LED_XANH);
               break;
            }

            if(input(LIMIT_CLOSE)) {
               // C?a dóng h?t
               motor_stop();
               output_low(LED_DO);
               output_low(LED_XANH);
               break;
            }
         }

         motor_stop();
         output_low(LED_DO);
         output_low(LED_XANH);
      }
   }
}

