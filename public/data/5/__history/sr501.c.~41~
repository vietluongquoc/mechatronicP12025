#include <16F887.h>
#fuses XT, NOWDT, NOPUT, NOLVP
#use delay(clock=12000000)

#define PIR        PIN_A0
#define LED_XANH   PIN_D2
#define LED_DO     PIN_D3
#define IN1        PIN_C0
#define IN2        PIN_C1
#define ENA        PIN_C2
#define LIMIT_MO   PIN_B0
#define LIMIT_DONG PIN_B1

// Hàm ch?ng rung và xác nh?n tín hi?u ?n d?nh
int1 debounce_input(int pin, int delay_ms, int min_stable_ms) {
   if (input(pin)) {
      delay_ms(delay_ms);
      if (input(pin)) {
         for (int i = 0; i < min_stable_ms; i += delay_ms) {
            if (!input(pin)) return 0;
            delay_ms(delay_ms);
         }
         return 1;
      }
   }
   return 0;
}

// Hàm debug b?ng nh?p nháy LED_XANH
void debug_blink(int count) {
   for (int i = 0; i < count; i++) {
      output_high(LED_XANH);
      delay_ms(100);
      output_low(LED_XANH);
      delay_ms(100);
   }
}

void motor_mo() {
   output_low(IN1);
   output_low(IN2);
   delay_ms(20); // Ch? d? tránh nhi?u
   output_high(IN1);
   output_low(IN2);
   output_high(ENA); // B?t ENA tr?c ti?p thay vì PWM
   output_high(LED_DO);
}

void motor_dong() {
   output_low(IN1);
   output_low(IN2);
   delay_ms(20); // Ch? d? tránh nhi?u
   output_low(IN1);
   output_high(IN2);
   output_high(ENA); // B?t ENA tr?c ti?p thay vì PWM
   output_high(LED_DO);
}

void motor_dung() {
   output_low(IN1);
   output_low(IN2);
   output_low(ENA);
   output_low(LED_DO);
   delay_ms(50); // Ch? L298N ?n d?nh
}

void den_do_nhap_nhay() {
   for(int i = 0; i < 4; i++) {
      output_toggle(LED_DO);
      delay_ms(500);
   }
   output_low(LED_DO);
}

void main() {
   set_tris_a(0xFF); // RA0 input
   set_tris_b(0xFF); // RB0, RB1 input
   set_tris_c(0x00); // Motor
   set_tris_d(0x00); // LEDs

   // Ki?m tra LED d? lúc kh?i d?ng
   output_high(LED_DO);
   delay_ms(2000);
   output_low(LED_DO);
   output_low(LED_XANH);
   motor_dung();

   while(TRUE) {
      // Ki?m tra PIR, yêu c?u tín hi?u ?n d?nh 2000ms
      if (debounce_input(PIR, 20, 2000)) {
         debug_blink(2); // Nh?p nháy 2 l?n khi phát hi?n PIR
         output_high(LED_XANH);
         motor_mo();

         // Ch? t?i khi ch?m LIMIT_MO ho?c m?t PIR
         while (!debounce_input(LIMIT_MO, 20, 200)) {
            if (!debounce_input(PIR, 20, 200)) {
               debug_blink(3); // Nh?p nháy 3 l?n n?u m?t PIR
               break;
            }
         }

         motor_dung();
         output_low(LED_XANH);

         // Ch? 5 giây
         delay_ms(5000);

         // Nh?p nháy dèn d?
         den_do_nhap_nhay();

         // Quay ngh?ch
         motor_dong();

         // Ki?m tra LIMIT_DONG ho?c PIR
         while (!debounce_input(LIMIT_DONG, 20, 200)) {
            if (debounce_input(PIR, 20, 2000)) {
               debug_blink(4); // Nh?p nháy 4 l?n n?u PIR xu?t hi?n
               motor_dung();
               delay_ms(200);
               output_high(LED_XANH);
               motor_mo();
               while (!debounce_input(LIMIT_MO, 20, 200) && debounce_input(PIR, 20, 200));
               break;
            }
         }

         motor_dung();
         output_low(LED_XANH);
      }
   }
}
