#include <16F887.h>
#fuses XT, NOWDT, NOMCLR
#use delay(clock=12000000)

#define PIR         PIN_A0
#define LED_XANH    PIN_D2
#define LED_DO      PIN_D3
#define IN1         PIN_C0
#define IN2         PIN_C1
#define LIMIT_OPEN  PIN_B0
#define LIMIT_CLOSE PIN_B1

void motor_forward() {
   output_high(IN1);
   output_low(IN2);
}

void motor_reverse() {
   output_low(IN1);
   output_high(IN2);
}

void motor_stop() {
   output_low(IN1);
   output_low(IN2);
}

void main() {
   set_tris_a(0xFF);
   set_tris_b(0xFF);
   set_tris_c(0x00);
   set_tris_d(0x00);

   output_low(LED_XANH);
   output_low(LED_DO);
   motor_stop();

   while(TRUE) {
      if(input(PIR)) {
         // M? c?a n?u chua m? h?t
         if(input(LIMIT_OPEN)) {
            output_high(LED_XANH);
            delay_ms(200); // LED xanh nh?p nháy 1 l?n
            output_high(LED_DO);
            motor_forward();
            output_low(LED_XANH);

            while(input(LIMIT_OPEN)) {
               if(!input(LIMIT_OPEN)) break;
            }

            motor_stop();
            output_low(LED_DO);
         }

         // Ch? 2s
         delay_ms(2000);

dong_cua:
         // Ðóng c?a n?u chua dóng h?t
         if(input(LIMIT_CLOSE)) {
            output_high(LED_DO);
            motor_reverse();

            while(input(LIMIT_CLOSE)) {
               if(input(PIR)) {
                  // N?u phát hi?n ngu?i thì d?ng và m? l?i
                 
                  // delay nh? tru?c khi m? l?i

                  // M? l?i c?a
                  if(input(LIMIT_OPEN)) {
                     output_high(LED_XANH);
                     delay_ms(200);
                     
                     motor_forward();
                     output_low(LED_XANH);

                     while(input(LIMIT_OPEN)) {
                        if(!input(LIMIT_OPEN)) break;
                     }

                     motor_stop();
                     output_low(LED_DO);
                     output_low(LED_XANH);
                  }

                  delay_ms(2000); // ch? r?i dóng l?i
                  goto dong_cua; // quay l?i dóng c?a ti?p
               }
            }

            motor_stop();
            output_low(LED_DO);
         }

         output_low(LED_XANH);
      }
   }
}

