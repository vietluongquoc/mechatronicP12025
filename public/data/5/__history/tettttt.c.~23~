#include <16F887.h>
#fuses HS, NOWDT, NOPROTECT, NOLVP
#use delay(clock=12000000)
#use fast_io(B)
#use fast_io(D)
#use fast_io(C)

#define PIR_SENSOR PIN_A0
#define GREEN_LED PIN_D2
#define RED_LED PIN_D3

void servo_rotate(int angle) {
   // Chu k? PWM 20ms, t?n s? 50Hz
   // Góc 0°: 0.5ms (2.5% duty), Góc 90°: 1.5ms (7.5% duty)
   int duty = (int)((0.5 + (angle * 1.0 / 90.0)) * 1023.0 / 20.0); // Tính duty cycle
   set_pwm1_duty(duty);
}

void main() {
   // C?u hình c?ng
   set_tris_b(0x01); // RB0 là input (SR501)
   set_tris_d(0x00); // RD2, RD3 là output (LED)
   set_tris_c(0x00); // RC2 là output (Servo PWM)
   
   // C?u hình PWM cho servo (RC2/CCP1)
   setup_ccp1(CCP_PWM);
   setup_timer_2(T2_DIV_BY_16, 149, 1); // Chu k? PWM = 20ms (50Hz) v?i Fosc=12MHz
   set_pwm1_duty(0); // Kh?i t?o servo ? 0°

   // Kh?i t?o LED
   output_low(GREEN_LED);
   output_low(RED_LED);

   int angle = 0;
   int detecting = 0;

   while(TRUE) {
      if(input(PIR_SENSOR)) { // Phát hi?n ngu?i
         if(!detecting) { // Chuy?n t? không phát hi?n sang phát hi?n
            detecting = 1;
            output_high(GREEN_LED); // B?t LED xanh
            output_low(RED_LED);    // T?t LED d?
            
            // Quay servo t? 0° d?n 90° (ch?m)
            for(angle = 0; angle <= 90; angle += 2) {
               servo_rotate(angle);
               delay_ms(50);
            }
         }
         
         output_low(GREEN_LED);  // T?t LED xanh
         output_high(RED_LED);   // B?t LED d?
         
         // Gi? servo ? 90° trong 5 giây
         delay_ms(5000);
         
         // Quay servo v? 0° (ch?m)
         for(angle = 90; angle >= 0; angle -= 2) {
            servo_rotate(angle);
            delay_ms(50);
            if(input(PIR_SENSOR)) { // N?u phát hi?n ngu?i trong lúc quay v?
               // Quay l?i 90°
               for(angle = angle; angle <= 90; angle += 2) {
                  servo_rotate(angle);
                  delay_ms(50);
               }
               output_low(GREEN_LED); // T?t LED xanh
               output_high(RED_LED);  // B?t LED d?
               delay_ms(5000);        // Gi? 5 giây
            }
         }
      } else { // Không phát hi?n ngu?i
         detecting = 0;
         output_low(GREEN_LED); // T?t LED xanh
         output_low(RED_LED);   // T?t LED d?
         servo_rotate(0);       // Servo ? 0°
      }
   }
}
