#include <16F887.h>
#fuses XT, NOWDT, NOMCLR
#use delay(clock=12000000)

// --- Ð?nh nghia chân ---
#define PIR         PIN_A0
#define BTN_STOP    PIN_A1
#define BTN_OPEN    PIN_A2
#define BTN_CLOSE   PIN_A3

#define LED_XANH    PIN_D2
#define LED_DO      PIN_D3

#define IN1         PIN_C0
#define IN2         PIN_C1

#define LIMIT_OPEN  PIN_B0
#define LIMIT_CLOSE PIN_B1

// --- Ði?u khi?n motor ---
void motor_forward() {
   output_high(IN1);
   output_low(IN2);
}

void motor_reverse() {
   output_low(IN1);
   output_high(IN2);
}

void motor_stop() {
   output_low(IN1);
   output_low(IN2);
}

void main() {
   set_tris_a(0xFF); // A0-A3 input (PIR + nút nh?n)
   set_tris_b(0xFF); // B0-B1 input (công t?c hành trình)
   set_tris_c(0x00); // Motor output
   set_tris_d(0x00); // LED output

   output_low(LED_XANH);
   output_low(LED_DO);
   motor_stop();

   while(TRUE) {
      // === NÚT D?NG ===
      if(input(BTN_STOP) == 0) {
         motor_stop();
         output_low(LED_XANH);
         output_low(LED_DO);
         continue;
      }

      // === NÚT M? ===
      if(input(BTN_OPEN) == 0) {
         if(input(LIMIT_OPEN)) {
            output_high(LED_XANH);
            motor_forward();
            while(input(LIMIT_OPEN)) {
               if(input(BTN_STOP) == 0) break;
            }
            motor_stop();
            output_low(LED_XANH);
         }
         continue;
      }

      // === NÚT ÐÓNG ===
      if(input(BTN_CLOSE) == 0) {
         if(input(LIMIT_CLOSE)) {
            output_high(LED_DO);
            motor_reverse();
            while(input(LIMIT_CLOSE)) {
               if(input(BTN_STOP) == 0) break;
            }
            motor_stop();
            output_low(LED_DO);
         }
         continue;
      }

      // === T? Ð?NG KHI CÓ NGU?I ===
      if(input(PIR)) {
         // M? C?A
         if(input(LIMIT_OPEN)) {
            output_high(LED_XANH);
            output_high(LED_DO);
            motor_forward();
            while(input(LIMIT_OPEN)) {
               if(input(BTN_STOP) == 0) break;
            }
            motor_stop();
            output_low(LED_DO);
         }

         delay_ms(2000); // Ch? 2 giây

         // ÐÓNG C?A
         if(input(LIMIT_CLOSE)) {
            output_high(LED_DO);
            motor_reverse();

            int nguoi_phat_hien = 0;
            while(input(LIMIT_CLOSE)) {
               if(input(PIR)) {
                  nguoi_phat_hien = 1;
                  break;
               }
               if(input(BTN_STOP) == 0) break;
            }
            motor_stop();
            output_low(LED_DO);

            if(nguoi_phat_hien) {
               // M? L?I
               if(input(LIMIT_OPEN)) {
                  output_high(LED_XANH);
                  output_high(LED_DO);
                  motor_forward();
                  while(input(LIMIT_OPEN)) {
                     if(input(BTN_STOP) == 0) break;
                  }
                  motor_stop();
                  output_low(LED_DO);
                  output_low(LED_XANH);
               }

               delay_ms(2000);

               // ÐÓNG L?I
               if(input(LIMIT_CLOSE)) {
                  output_high(LED_DO);
                  motor_reverse();
                  while(input(LIMIT_CLOSE)) {
                     if(input(BTN_STOP) == 0) break;
                  }
                  motor_stop();
                  output_low(LED_DO);
               }
            }

            output_low(LED_XANH);
         }
      }
   }
}

