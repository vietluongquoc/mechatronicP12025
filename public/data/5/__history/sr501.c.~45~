#include <16F887.h>
#fuses INTRC_IO, NOWDT
#use delay(clock=8000000)

#define MOTOR_1_IN1  PIN_C0  // Ði?u khi?n d?ng co quay thu?n
#define MOTOR_1_IN2  PIN_C1  // Ði?u khi?n d?ng co quay ngu?c
#define SENSOR_PIN    PIN_A0  // C?m bi?n HC-SR501 n?i RA0
#define LED_GREEN      PIN_D2  // LED xanh n?i RD2
#define LED_RED        PIN_D3  // LED d? n?i RD3

void main() {
   set_tris_a(0xFF); // T?t c? c?ng A là input (c?m bi?n)
   set_tris_d(0x00); // C?ng D là output (LED)
   set_tris_c(0x00); // C?ng C là output (d?ng co)

   bool motor_running = false;

   while(true) {
      // Ki?m tra c?m bi?n phát hi?n ngu?i (s? d?ng debounce d? gi?m nhi?u)
      if(input(SENSOR_PIN) == 1 && !motor_running) { // Có ngu?i và d?ng co chua ch?y
         output_high(LED_GREEN); // Ðèn xanh sáng
         output_high(LED_RED);   // Ðèn d? sáng
         output_high(MOTOR_1_IN1); // Quay d?ng co thu?n
         output_low(MOTOR_1_IN2);
         motor_running = true; // Ð?ng co dã b?t d?u ch?y
      } else if(input(SENSOR_PIN) == 0 && motor_running) {
         // N?u không có ngu?i và d?ng co dang ch?y, d?ng d?ng co
         output_low(MOTOR_1_IN1);
         output_low(MOTOR_1_IN2);
         output_low(LED_GREEN); // T?t dèn xanh
         motor_running = false; // Ð?ng co dã d?ng
      }

      // N?u d?ng co dã d?ng và công t?c hành trình m? (c?a dã m? h?t)
      if(!input(PIN_A1)) {
         delay_ms(5000);  // Ð?i 5 giây

         // Quay d?ng co ngu?c l?i (dóng c?a)
         output_low(MOTOR_1_IN1);
         output_high(MOTOR_1_IN2);
         delay_ms(2000); // Ð?ng co quay ngu?c 2 giây
         output_low(MOTOR_1_IN1);
         output_low(MOTOR_1_IN2);

         // Nh?p nháy dèn d?
         for(int i=0; i<10; i++) {
            output_toggle(LED_RED);
            delay_ms(200);
         }

         // N?u dang quay ngu?c mà phát hi?n ngu?i, quay thu?n l?i
         if(input(SENSOR_PIN) == 1) {
            output_high(MOTOR_1_IN1);
            output_low(MOTOR_1_IN2);
         }
      }
   }
}

