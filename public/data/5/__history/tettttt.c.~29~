#include <16F887.h>
#fuses INTRC_IO, NOWDT, NOPUT, NOLVP
#use delay(clock=8000000)
#use fast_io(A)
#use fast_io(C)
#use fast_io(D)

#define PIR      PIN_A0
#define LED_XANH PIN_D2
#define LED_DO   PIN_D3
#define SERVO    PIN_C2

int goc_hien_tai = 0;

// Hàm di?u khi?n servo MG996R
void servo_write(int angle) {
   int pulse_width;
   if(angle < 0) angle = 0;
   if(angle > 90) angle = 90;
   pulse_width = 500 + ((int32)angle * 2000 / 180); // MG996R chu?n
   output_high(SERVO);
   delay_us(pulse_width);
   output_low(SERVO);
   delay_ms(20 - pulse_width / 1000);
}

// Gi? servo ? 1 góc c? d?nh trong 1 kho?ng th?i gian
void servo_giu(int angle, int time_ms) {
   int count = time_ms / 20;
   for(int i = 0; i < count; i++) {
      servo_write(angle);
   }
}

// Quay servo t? A ? B ch?m t?ng bu?c
void servo_quay_cham(int from, int to, int delay_ms_step) {
   if(from < to) {
      for(int i = from; i <= to; i++) {
         servo_write(i);
         delay_ms(delay_ms_step);
      }
   } else {
      for(int i = from; i >= to; i--) {
         servo_write(i);
         delay_ms(delay_ms_step);
      }
   }
   goc_hien_tai = to;
}

void main() {
   set_tris_a(0xFF); // PIR input
   set_tris_c(0x00); // Servo output
   set_tris_d(0x00); // LED output

   output_low(LED_XANH);
   output_low(LED_DO);
   output_low(SERVO);

   while(true) {
      if(input(PIR)) {
         output_high(LED_XANH);     // sáng xanh li?n
         delay_ms(1000);            // d?i 1 giây
         output_high(LED_DO);       // b?t dèn d?

         // M? C?A: quay ch?m t? 0 ? 90
         servo_quay_cham(goc_hien_tai, 90, 40);
         servo_giu(90, 5000);        // gi? ? 90 d? 5 giây
         output_low(LED_DO);        // t?t dèn d?
         
         delay_ms(3000);            // ch? 3 giây r?i m?i dóng
         output_high(LED_DO);       // b?t l?i dèn d? khi dóng

         // ÐÓNG C?A: quay t? 90 ? 0
         for(int i = goc_hien_tai; i >= 0; i--) {
            if(input(PIR)) {
               // n?u phát hi?n ngu?i thì m? l?i
               servo_quay_cham(i, 90, 40);
               servo_giu(90, 5000);
               delay_ms(3000); // ch? r?i dóng l?i
               i = 91; // d? for ch?y l?i t? 90
               continue;
            }
            servo_write(i);
            delay_ms(40);
            goc_hien_tai = i;

            // c?p nh?t LED xanh theo PIR
            if(input(PIR)) output_high(LED_XANH);
            else output_low(LED_XANH);
         }

         output_low(LED_DO);   // dóng xong thì t?t dèn d?

         // ch? d?n khi c?m bi?n ngung báo
         while(input(PIR)) {
            output_high(LED_XANH);
            delay_ms(10);
         }
         output_low(LED_XANH);
      }
      else {
         output_low(LED_XANH);
         delay_ms(10);
      }
   }
}

