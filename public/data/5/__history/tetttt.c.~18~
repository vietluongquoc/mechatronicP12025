#include <16F887.h>
#fuses HS, NOWDT, NOPUT, NOLVP
#use delay(clock=12000000)

#define TRIG    PIN_C0
#define ECHO    PIN_C1
#define LED     PIN_D2
#define BUZZER  PIN_D3

void send_trigger() {
   output_low(TRIG);
   delay_us(2);
   output_high(TRIG);
   delay_us(10);
   output_low(TRIG);
}

// Ðo d? r?ng xung Echo (tr? v? us)
unsigned int16 get_echo_time() {
   unsigned int16 t = 0;
   int timeout = 30000;

   while(!input(ECHO) && timeout--); // Ch? lên cao
   set_timer1(0);
   while(input(ECHO)) {
      if(get_timer1() > 30000) break;
   }

   t = get_timer1();
   return t;
}

// Tính kho?ng cách (don v?: cm)
unsigned int16 get_distance_cm() {
   unsigned int16 duration = 0;
   float distance_cm = 0;

   send_trigger();
   duration = get_echo_time();

   distance_cm = (float)duration / 58.0;

   return (unsigned int16)distance_cm;
}

// B?t còi bíp bíp trong 5 giây
void beep_5_seconds() {
   int i;
   for(i = 0; i < 25; i++) {  // 25 l?n -> 5 giây (25 x 200ms)
      output_high(BUZZER);
      delay_ms(100);
      output_low(BUZZER);
      delay_ms(100);
   }
}

void main() {
   set_tris_c(0b00000010); // RC1 input, RC0 output
   set_tris_d(0b11110011); // RD2 & RD3 output

   setup_timer_1(T1_INTERNAL | T1_DIV_BY_1); // 1us/tick
   output_low(LED);
   output_low(BUZZER);

   while(TRUE) {
      unsigned int16 distance = get_distance_cm();

      if(distance > 0 && distance <= 10) {
         output_high(LED);
         beep_5_seconds();
         output_low(LED);
      } else {
         output_low(LED);
         output_low(BUZZER);
      }

      delay_ms(200);
   }
}

