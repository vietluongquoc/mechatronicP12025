#include <16F887.h>
#fuses XT, NOWDT, NOMCLR
#use delay(clock=12000000)

#define cambien     PIN_A1
#define nut_mo      PIN_A2
#define nut_chedo   PIN_A3
#define nut_dong    PIN_A4

#define ledxanh     PIN_D2
#define leddo       PIN_D3
#define IN1         PIN_C0
#define IN2         PIN_C1
#define ctmo        PIN_B1
#define ctdong      PIN_B0

int chedo_tay = 0;
int last_state = 1;

void quaythuan() {
   output_high(IN1);
   output_low(IN2);
}

void quaynguoc() {
   output_low(IN1);
   output_high(IN2);
}

void dung() {
   output_low(IN1);
   output_low(IN2);
}

void chuyen_che_do() {
   // Ch?ng d?i nút
   delay_ms(20);
   if(input(nut_chedo) == 0 && last_state == 1) {
      chedo_tay = !chedo_tay;
      dung(); // d?ng motor khi chuy?n ch? d?
      output_low(ledxanh);
      output_low(leddo);
   }
   last_state = input(nut_chedo);
}

void main() {
   set_tris_a(0xFF);
   set_tris_b(0xFF);
   set_tris_c(0x00);
   set_tris_d(0x00);

   output_low(ledxanh);
   output_low(leddo);
   dung();

   while(TRUE) {
      chuyen_che_do(); // luôn ki?m tra chuy?n ch? d?

      if(chedo_tay) {
         // CH? Ð? TAY
         if(input(nut_mo) == 0) {
            quaythuan();
            output_low(ledxanh);
            output_high(leddo);
         }
         else if(input(nut_dong) == 0) {
            quaynguoc();
            output_low(ledxanh);
            output_high(leddo);
         }
         else {
            dung();
            output_low(ledxanh);
            output_low(leddo);
         }
      }
      else {
         // CH? Ð? T? Ð?NG
         if(input(cambien)) {
            output_high(ledxanh);
            delay_ms(200);
            output_low(ledxanh);
            output_high(leddo);

            if(input(ctmo)) {
               quaythuan();
               while(input(ctmo)) {
                  chuyen_che_do(); // cho phép chuy?n ch? d? trong khi m?
                  if(chedo_tay) break;
               }
               dung();
               output_low(leddo);
               if(chedo_tay) continue;
            }

            delay_ms(2000);
            if(chedo_tay) continue;

dong_cua:
            if(input(ctdong)) {
               output_high(leddo);
               quaynguoc();
               while(input(ctdong)) {
                  chuyen_che_do(); // cho phép chuy?n ch? d? trong khi dóng
                  if(chedo_tay) break;
                  if(input(cambien)) {
                     if(input(ctmo)) {
                        output_high(ledxanh);
                        delay_ms(200);
                        output_low(ledxanh);
                        quaythuan();
                        while(input(ctmo)) {
                           chuyen_che_do();
                           if(chedo_tay) break;
                        }
                        dung();
                        output_low(leddo);
                        output_low(ledxanh);
                     }
                     delay_ms(2000);
                     if(chedo_tay) continue;
                     goto dong_cua;
                  }
               }
               dung();
               output_low(leddo);
            }
            output_low(ledxanh);
         }
      }
   }
}

